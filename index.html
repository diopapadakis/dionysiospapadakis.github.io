<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dionysios Papadakis</title>
    <link rel="icon" type="image/x-icon" href="NYU_favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Leaflet (map) CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
        :root {
            --nyu-purple: #57068c;
            --nyu-purple-soft: #f6f0ff;
            --nyu-dark: #1f1235;
            --text-main: #222222;
            --text-muted: #555555;
            --border-soft: #e3d5ff;
            --link-hover: #3c0466;
            --paper-bg: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: var(--text-main);
            background: #fafafa;
            line-height: 1.6;
        }

        a { color: var(--nyu-purple); text-decoration: none; }
        a:hover { color: var(--link-hover); text-decoration: underline; }

        .page {
            max-width: 820px;
            margin: 3rem auto 4rem auto;
            padding: 0 1.25rem;
        }

        header {
            margin-bottom: 2.5rem;
            border-bottom: 1px solid var(--border-soft);
            padding-bottom: 1.75rem;
        }

        .top-row {
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
        }

        .profile-photo {
            flex-shrink: 0;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--nyu-purple);
        }

        @media (max-width: 640px) {
            .top-row { flex-direction: column-reverse; align-items: flex-start; }
            .profile-photo { width: 100px; height: 100px; }
        }

        h1 {
            font-size: 1.9rem;
            font-weight: 650;
            color: var(--nyu-dark);
            margin-bottom: 0.2rem;
        }

        .affiliation {
            font-size: 0.98rem;
            color: var(--text-muted);
            margin-bottom: 0.6rem;
        }

        .affiliation strong {
            color: var(--nyu-purple);
            font-weight: 600;
        }

        .tagline {
            font-size: 0.98rem;
            margin-bottom: 0.6rem;
        }

        .mini-links {
            display: flex;
            flex-wrap: wrap;
            gap: 0.55rem;
            align-items: center;
            margin-top: 0.55rem;
        }

        .cv-link {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.45rem 0.9rem;
            border-radius: 999px;
            border: 1px solid var(--nyu-purple);
            background: #ffffff;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--nyu-purple);
        }

        .cv-link:hover {
            background: var(--nyu-purple-soft);
            text-decoration: none;
        }

        /* Small Trips button */
        .trip-link {
            display: inline-flex;
            align-items: center;
            padding: 0.26rem 0.65rem;
            border-radius: 999px;
            border: 1px solid var(--border-soft);
            background: #ffffff;
            font-size: 0.78rem;
            font-weight: 550;
            color: var(--nyu-purple);
            opacity: 0.95;
        }

        .trip-link:hover {
            background: var(--nyu-purple-soft);
            text-decoration: none;
            border-color: var(--nyu-purple);
        }

        section { margin-bottom: 2.5rem; }

        h2 {
            font-size: 1.4rem;
            margin-bottom: 0.75rem;
            color: var(--nyu-dark);
        }

        h2::after {
            content: "";
            display: block;
            width: 46px;
            height: 3px;
            border-radius: 999px;
            background: linear-gradient(90deg, var(--nyu-purple), var(--nyu-purple-soft));
            margin-top: 0.3rem;
        }

        .papers-list { list-style: none; margin: 0.2rem 0 0; }

        .paper {
            padding: 1.1rem 1rem;
            margin-bottom: 1rem;
            background: var(--paper-bg);
            border-radius: 0.5rem;
            border-left: 3px solid var(--nyu-purple);
            border-right: 1px solid var(--border-soft);
            border-top: 1px solid var(--border-soft);
            border-bottom: 1px solid var(--border-soft);
        }

        .paper-title { font-weight: 600; font-size: 1.02rem; }
        .paper-title i { font-style: italic; }

        .paper-meta {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 0.15rem;
        }

        .paper-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            margin-bottom: 0.35rem;
        }

        .pill-link {
            padding: 0.2rem 0.7rem;
            border-radius: 999px;
            border: 1px solid var(--nyu-purple);
            color: var(--nyu-purple);
            font-size: 0.86rem;
            font-weight: 500;
            text-decoration: none;
            background: #fff;
        }

        .pill-link:hover {
            background: var(--nyu-purple-soft);
            text-decoration: none;
        }

        .abstract-toggle {
            padding: 0.2rem 0.7rem;
            border-radius: 999px;
            border: 1px solid var(--border-soft);
            background: var(--nyu-purple-soft);
            font-size: 0.86rem;
            cursor: pointer;
        }

        .abstract-toggle:hover { border-color: var(--nyu-purple); }

        .pill-btn{
            padding: 0.2rem 0.7rem;
            border-radius: 999px;
            border: 1px solid var(--border-soft);
            background: var(--nyu-purple-soft);
            font-size: 0.86rem;
            cursor: pointer;
            font-weight: 550;
            color: var(--nyu-dark);
        }
        .pill-btn:hover { border-color: var(--nyu-purple); }


        .abstract-box {
            margin-top: 0.5rem;
            padding-top: 0.4rem;
            border-top: 1px dashed var(--border-soft);
            font-size: 0.93rem;
            color: var(--text-muted);
        }

        .abstract-box[hidden] { display: none; }

        .contact-line { font-size: 0.95rem; margin-bottom: 0.25rem; }
        .contact-line strong { font-weight: 600; }

        footer {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
            padding: 1.5rem 0 2rem;
            border-top: 1px solid var(--border-soft);
            margin-top: 1.5rem;
        }

        .footer-nyu-tag { color: var(--nyu-purple); font-weight: 500; }

        /* =========================
           Trips overlay "page"
           ========================= */
        .trips-overlay[hidden] { display: none; }

        .trips-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: #fafafa;
            overflow: auto;
        }

        .trips-bar {
            position: sticky;
            top: 0;
            z-index: 1;
            background: rgba(250, 250, 250, 0.92);
            backdrop-filter: blur(6px);
            border-bottom: 1px solid var(--border-soft);
        }

        .trips-bar-inner {
            max-width: 980px;
            margin: 0 auto;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .back-btn {
            all: unset;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--border-soft);
            background: #fff;
            color: var(--nyu-purple);
            font-weight: 600;
            font-size: 0.9rem;
        }
        .pill-disabled{
            border-color: var(--border-soft);
            color: var(--text-muted);
            background: #fff;
            cursor: default;
            pointer-events: none;
        }

        .back-btn:hover {
            background: var(--nyu-purple-soft);
            border-color: var(--nyu-purple);
        }

        .trips-title {
            font-size: 0.95rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
            user-select: none;
        }

        .trips-content {
            max-width: 980px;
            margin: 16px auto 28px auto;
            padding: 0 14px;
        }

        .trips-intro {
            color: var(--text-muted);
            margin: 10px 0 14px 0;
            font-size: 0.95rem;
        }

        .figure-box{
            margin-top: 0.5rem;
            padding-top: 0.6rem;
            border-top: 1px dashed var(--border-soft);
        }

        .figure-box[hidden] { display: none; }

        .paper-figure{
            width: 100%;
            height: auto;
            display: block;
            border-radius: 12px;
            border: 1px solid var(--border-soft);
            background: #fff;
            box-shadow: 0 10px 30px rgba(31, 18, 53, 0.06);
        }


        #tripMap {
            width: 100%;
            height: min(62vh, 560px);
            border-radius: 14px;
            border: 1px solid var(--border-soft);
            overflow: hidden;
            background: #fff;

            /* add “card” feel */
            box-shadow: 0 10px 30px rgba(31, 18, 53, 0.08);
            }

            /* soften the default tile harshness a bit */
            .leaflet-tile {
            filter: saturate(0.9) contrast(1.05) brightness(1.02);
            }

            .leaflet-control-attribution {
            font-size: 11px;
            opacity: 0.75;
        }


        .trip-pin { background: transparent; border: none; }

        /* force a perfect circle */
        .trip-pin-dot{
        display: block;            /* key: makes width/height apply */
        width: 14px;
        height: 14px;
        border-radius: 50%;
        line-height: 0;            /* prevents inline/line-height stretching */

        background: var(--nyu-purple);
        border: 2px solid rgba(255,255,255,0.95);
        box-shadow:
            0 8px 14px rgba(23, 6, 53, 0.22),
            0 0 0 1px rgba(87, 6, 140, 0.20);

        

        .trip-pin-dot:hover{
        transform: scale(1.12);
        filter: brightness(1.05);
        }


        /* optional subtle pulse so pins read as “the point” */
        .trip-pin-dot::after{
        content:"";
        position:absolute;
        inset:-10px;
        border-radius:999px;
        background: rgba(87, 6, 140, 0.18);
        animation: pinPulse 1.8s ease-out infinite;
        }
        @keyframes pinPulse{
        0% { transform: scale(0.55); opacity: 0.0; }
        35%{ opacity: 0.75; }
        100%{ transform: scale(1.25); opacity: 0.0; }
        }


        .leaflet-popup-content { margin: 10px 12px; }
    </style>
</head>

<body>
<main class="page">
    <header>
        <div class="top-row">
            <div>
                <h1>Dionysios Papadakis</h1>
                <p class="affiliation">
                    PhD Student in Economics, <strong>New York University</strong>
                </p>

                <p class="tagline">
                    I am a first year Economics PhD student at NYU. I am interested in topics related to Economic Theory and Political Economy. My research so far has been in cultural transmission.
                    Outside of economics, I enjoy <a href="#" class="open-trips">travelling</a> and biking.
                </p>

                <div class="mini-links">
                    <a class="cv-link" href="cv.pdf" target="_blank" rel="noopener">
                        <span>Download CV</span>
                    </a>
                    <a class="trip-link open-trips" href="#" id="tripsButton" title="Open trips">
                        Trips
                    </a>
                </div>
            </div>

            <img src="web_pic.png" alt="Dionysios Papadakis" class="profile-photo">
        </div>
    </header>

    <section id="research">
        <h2>Research</h2>

        <ul class="papers-list">
            <li class="paper">
                <div class="paper-title">
                    <span class="paper-main-title">
                        <i>On the Economics of Cultural Transmission: Welfare Analysis</i>
                    </span>
                    <div class="coauthor">
                        with
                        <a href="https://wp.nyu.edu/albertobisin/" target="_blank" rel="noopener">
                            Alberto Bisin
                        </a>
                    </div>
                </div>

                <p class="paper-meta">
                    Working paper
                </p>

                <div class="paper-controls">
                    <!--<a class="pill-link"
                       href="https://drive.google.com/file/d/15vtZmEFgxn3HTa1GxUIporQMgQmWX5vE/view?usp=drive_link"
                       target="_blank" rel="noopener">
                        PDF
                    </a>-->
                    <span class="pill-link pill-disabled" aria-disabled="true">
                        PDF coming soon
                    </span>
                    
                    <button type="button" class="pill-btn abstract-toggle">Show abstract</button>

                    <button type="button" class="pill-btn figure-toggle">Show figure</button>

                </div>

                <div class="abstract-box" hidden>
                    <p>
                        We study the efficiency properties of the dynamics of the distribution of cultural traits at equilibrium. 
                        We study cultural transmission processes  governed by  parental socialization choices and social interactions as well as processes  mediated by cultural leaders. 
                        We define efficiency via a social welfare function over parents’ ex-ante preferences and show that an externality induces parents to generally under-supply socialization effort, while strategic complementarities induce cultural leaders to over-supply it.  
                    </p>
                </div>

                <div class="figure-box" hidden>
                    <img
                        class="paper-figure"
                        src="Graphs%20From%20Papers/On_the_Economics_of_Cultural_Tranmsission_Welfare_Analysis_Figure_2.png"
                        alt="Figure 2: Effects of an increase of tau_t^i"
                        loading="lazy"
                    />
                </div>
            </li>
        </ul>
    </section>

    <section id="contact">
        <h2>Contact</h2>
        <p class="contact-line">
            <strong>Email:</strong> dionysios.papadakis@nyu.edu
        </p>
        <p class="contact-line">
            <strong>Address:</strong> New York University, 19 West 4th Street, New York, NY 10003
        </p>
    </section>

    <footer>
        <div>© 2025 <span class="footer-nyu-tag">Dionysios Papadakis</span></div>
    </footer>
</main>

<!-- Trips overlay page (hidden until opened) -->
<section id="tripsOverlay" class="trips-overlay" hidden aria-hidden="true">
    <div class="trips-bar">
        <div class="trips-bar-inner">
            <button type="button" class="back-btn" id="tripsBackBtn" aria-label="Go back">
                ← Back
            </button>
            <div class="trips-title">Trips</div>
            <div style="width: 78px;"></div>
        </div>
    </div>

    <div class="trips-content">
        <p class="trips-intro">All photos were taken by me during the trips (the quality might be bad).</p>
        <div id="tripMap" aria-label="World map with visited places"></div>
    </div>
</section>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // =========================
    // Abstract show/hide toggles
    // =========================
    document.querySelectorAll(".abstract-toggle").forEach(function (btn) {
        btn.addEventListener("click", function () {
            const paper = btn.closest(".paper");
            const box = paper.querySelector(".abstract-box");
            const isHidden = box.hasAttribute("hidden");

            if (isHidden) {
                box.removeAttribute("hidden");
                btn.textContent = "Hide abstract";
            } else {
                box.setAttribute("hidden", "");
                btn.textContent = "Show abstract";
            }
        });
    });
</script>

<script>
    document.querySelectorAll(".figure-toggle").forEach(function (btn) {
        btn.addEventListener("click", function () {
            const paper = btn.closest(".paper");
            const box = paper.querySelector(".figure-box");
            const isHidden = box.hasAttribute("hidden");
            if (isHidden) {
                box.removeAttribute("hidden");
                btn.textContent = "Hide figure";
            } else {
                box.setAttribute("hidden", "");
                btn.textContent = "Show figure";
            }
        });
    });

</script>

<script>

    // =========================
    // Trips overlay + map pins
    // =========================

    const MONTHS = [
        "January","February","March","April","May","June",
        "July","August","September","October","November","December"
    ];

    function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, (m) => ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;"
        }[m]));
    }

    function titleCaseFromSlug(slug) {
        // preserve common acronyms
        const acronyms = new Set(["NYC","NY","UAE","EU"]);
        return slug
            .split("_")
            .filter(Boolean)
            .map(part => {
                const upper = part.toUpperCase();
                if (acronyms.has(upper)) return upper;
                // keep "Ho" "Chi" "Minh" etc nicely
                return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
            })
            .join(" ");
    }

    function parseFromFilename(path) {
        // expects something like: travel_photos/City_Island_NY_25_10_25.jpg
        const file = path.split("/").pop() || path;
        const base = file.replace(/\.[^.]+$/, ""); // remove extension
        const parts = base.split("_");
        if (parts.length < 4) {
            return { placeName: base, dateStr: "" };
        }

        const yy = parts[parts.length - 1];
        const mm = parts[parts.length - 2];
        const dd = parts[parts.length - 3];
        const placeParts = parts.slice(0, parts.length - 3);

        const day = parseInt(dd, 10);
        const month = parseInt(mm, 10);
        const year2 = parseInt(yy, 10);

        const year = (year2 >= 0 && year2 <= 99) ? (2000 + year2) : year2;
        const monthName = (month >= 1 && month <= 12) ? MONTHS[month - 1] : "";

        const placeName = titleCaseFromSlug(placeParts.join("_"));
        const dateStr = (day && monthName && year) ? `${day} ${monthName} ${year}` : "";

        return { placeName, dateStr };
    }

    function dedupePins(pins) {
        const seen = new Set();
        const out = [];
        for (const p of pins) {
            const key = (p.file || "").trim().toLowerCase();
            if (!key) continue;
            if (seen.has(key)) continue;
            seen.add(key);
            out.push(p);
        }
        return out;
    }

    // Add photos here. Duplicates (same filename/path) will be ignored automatically.
    // All images should live in: ./travel_photos/ (relative to this HTML file)
    const photoPinsRaw = [
        { file: "travel_photos/skopje_13_11_21.jpg", coords: [41.9973, 21.4280], country: "North Macedonia" },
        { file: "travel_photos/Berlin_25_9_21.jpg", coords: [52.5200, 13.4050], country: "Germany" },
        { file: "travel_photos/Vatican_City_6_6_22.jpg", coords: [41.9029, 12.4534], country: "Vatican City" },
        { file: "travel_photos/bologna_3_6_22.jpg", coords: [44.4949, 11.3426], country: "Italy" },
        { file: "travel_photos/istanbul_24_7_22.jpg", coords: [41.0082, 28.9784], country: "Turkey" },
        { file: "travel_photos/nyc_26_8_22.jpg", coords: [40.7128, -74.0060], country: "United States" },
        { file: "travel_photos/cold_springs_9_11_22.jpg", coords: [41.4145, -73.9546], country: "United States" },
        { file: "travel_photos/Parnitha_30_12_22.jpg", coords: [38.1500, 23.7500], country: "Greece" },
        { file: "travel_photos/amsterdam_26_11_26.jpg", coords: [52.3676, 4.9041], country: "Netherlands" },

        { file: "travel_photos/Bangkok_2_6_25.jpg", coords: [13.7563, 100.5018], country: "Thailand" },
        { file: "travel_photos/Brussels_24_7_23.jpg", coords: [50.8503, 4.3517], country: "Belgium" },
        { file: "travel_photos/Chania_2_8_23.jpg", coords: [35.5138, 24.0180], country: "Greece" },
        { file: "travel_photos/City_Island_NY_25_10_25.jpg", coords: [40.8468, -73.7879], country: "United States" },
        { file: "travel_photos/Doha_9_6_25.jpg", coords: [25.2854, 51.5310], country: "Qatar" },
        { file: "travel_photos/Dubrovnik_11_7_23.jpg", coords: [42.6507, 18.0944], country: "Croatia" },
        { file: "travel_photos/Frankfurt_20_7_23.jpg", coords: [50.1109, 8.6821], country: "Germany" },
        { file: "travel_photos/Ho_Chi_Minh_1_4_23.jpg", coords: [10.8231, 106.6297], country: "Vietnam" },
        { file: "travel_photos/Hockenheim_21_7_23.jpg", coords: [49.3268, 8.5450], country: "Germany" },

        { file: "travel_photos/Oslo_23_8_23.jpg", coords: [59.9139, 10.7522], country: "Norway" },
        { file: "travel_photos/San_Salvador_18_3_24.jpg", coords: [13.6929, -89.2182], country: "El Salvador" },
        { file: "travel_photos/Sapporo_30_7_24.jpg", coords: [43.0618, 141.3545], country: "Japan" },
        { file: "travel_photos/Shanghai_Jingan_31_8_24.jpg", coords: [31.2304, 121.4737], country: "China" ,caption: "View from my old apartment in Shanghai."},
        { file: "travel_photos/Shanghai_XUjiahui_1_5_23.jpg", coords: [31.1960, 121.4360], country: "China" },
        { file: "travel_photos/Trento_28_5_23.jpg", coords: [46.0703, 11.1210], country: "Italy" },
        { file: "travel_photos/Turin_31_5_2023.jpg", coords: [45.0703, 7.6869], country: "Italy" },

        // If you want to fix the displayed name (file is "Honk..." but show "Hong Kong"):
        { file: "travel_photos/Honk_Kong_30_5_25.jpg", coords: [22.3193, 114.1694], place: "Hong Kong", country: "China" },

        { file: "travel_photos/Jakarta_6_6_25.jpg", coords: [-6.2088, 106.8456], country: "Indonesia" },
        { file: "travel_photos/La_Libertad_El_Salvador_18_3_24.jpg", coords: [13.4883, -89.3220], country: "El Salvador" },
        { file: "travel_photos/Manama_Bahrain_30_1_25.jpg", coords: [26.2235, 50.5876], country: "Bahrain" },
        { file: "travel_photos/Marathopolis_3_aug_24.jpg", coords: [36.8787, 21.7283], country: "Greece" },
        { file: "travel_photos/Meteora_6_1_24.jpg", coords: [39.7217, 21.6306], country: "Greece" },
        { file: "travel_photos/Milan_6_6_23.jpg", coords: [45.4642, 9.1900], country: "Italy" },
        { file: "travel_photos/Moganshan_25_2_23.jpg", coords: [30.6260, 119.8850], country: "China" },
        { file: "travel_photos/Lima_11_1_2026.jpg", coords: [-12.0464, -77.0428], country: "Peru"},
        { file: "travel_photos/Tiwanaku_13_1_26.jpg", coords: [-16.5540, -68.6730], country: "Bolivia"},
        { file: "travel_photos/La_Paz_14_1_26.jpg", coords: [-16.4897, -68.1193], country: "Bolivia"},

        // Example of a fully custom caption (overrides the auto "Place, Country — Date"):
        // { file: "travel_photos/Doha_9_6_25.jpg", coords: [25.2854, 51.5310], country: "Qatar", caption: "View" },
    ];


    const photoPins = dedupePins(photoPinsRaw);

    const tripsOverlay = document.getElementById("tripsOverlay");
    const tripsBackBtn = document.getElementById("tripsBackBtn");

    let savedScrollY = 0;
    let tripMap = null;
    let tripMapInitialized = false;

    function openTrips() {
        savedScrollY = window.scrollY || 0;
        tripsOverlay.hidden = false;
        tripsOverlay.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";

        if (!tripMapInitialized) {
            initTripMap();
            tripMapInitialized = true;
        } else {
            setTimeout(() => tripMap && tripMap.invalidateSize(), 50);
        }

        setTimeout(() => tripsBackBtn?.focus(), 0);
    }

    function closeTrips() {
        tripsOverlay.hidden = true;
        tripsOverlay.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
        window.scrollTo(0, savedScrollY);
    }

    function initTripMap() {
        if (!window.L) {
            console.warn("Leaflet failed to load.");
            return;
        }

        tripMap = L.map("tripMap", {
            worldCopyJump: true,
            scrollWheelZoom: true
        }).setView([20, 0], 2);

        L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
            maxZoom: 19,
            attribution:
                '&copy; OpenStreetMap contributors &copy; CARTO'
        }).addTo(tripMap);


        const PIN_SIZE = 18;

        const pinIcon = L.divIcon({
        className: "trip-pin",
        html: '<span class="trip-pin-dot"></span>',
        iconSize: [PIN_SIZE, PIN_SIZE],
        iconAnchor: [PIN_SIZE / 2, PIN_SIZE / 2],
        popupAnchor: [0, -PIN_SIZE / 2]
        });


        const bounds = [];

        photoPins.forEach((p) => {
            bounds.push(p.coords);

            const { placeName, dateStr } = parseFromFilename(p.file);

            const displayPlace = p.place || placeName;
            const displayCountry = p.country || "";
            const titleText = displayCountry ? `${displayPlace}, ${displayCountry}` : displayPlace;

            // If you set p.caption, it fully overrides the caption line.
            const captionText = p.caption
                ? p.caption
                : (dateStr ? `${titleText} — ${dateStr}` : titleText);

            const safeName = escapeHtml(titleText);
            const safeCaption = escapeHtml(captionText);

            const popupHtml = `
                <div style="max-width: 300px;">
                    <div style="font-weight: 650; margin-bottom: 6px;">${safeName}</div>
                    <img
                        src="${p.file}"
                        alt="${safeName}"
                        loading="lazy"
                        style="width: 100%; height: auto; border-radius: 10px; display: block;"
                    />
                    <div style="opacity: 0.72; font-size: 12px; margin-top: 6px;">${safeCaption}</div>
                </div>
            `;

            L.marker(p.coords, {
                icon: pinIcon,
                riseOnHover: true
                })
                .addTo(tripMap)
                .bindPopup(popupHtml, { closeButton: true, maxWidth: 320 });
        });

        if (bounds.length >= 2) {
            tripMap.fitBounds(bounds, { padding: [30, 30] });
        } else if (bounds.length === 1) {
            tripMap.setView(bounds[0], 6);
        }
    }

    // Open from BOTH the "travelling" link and Trips button
    document.querySelectorAll(".open-trips").forEach((el) => {
        el.addEventListener("click", (e) => {
            e.preventDefault();
            openTrips();
        });
    });

    tripsBackBtn.addEventListener("click", closeTrips);

    // Escape closes overlay
    document.addEventListener("keydown", (e) => {
        if (!tripsOverlay.hidden && e.key === "Escape") closeTrips();
    });
</script>
</body>
</html>